<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>devRant</title>
    <link rel="stylesheet" href="../res/css/ionicons.min.css">
    <style>
      body, html {
        background: transparent;
        font: menu;
        overflow: hidden;
        margin: 0px;
      }
      #top {
        display: flex;
      }
      #notifimage {
        height: 72px;
        width: 72px;
        margin: 10px;
        border: none;
        border-radius: 100%;
        -webkit-app-region: drag;
      }
      #info {
        flex: 1;
        padding-left: 12px;
      }
      #header {
        margin-bottom: 6px;
        margin-top: 14px;
      }
      #desc {
        margin: 0px;
        width: 335px;
      }

      #text_area {
        margin: 10px;
      }
      button {
        height: 54px;
        width: 54px;
        margin: 6px 0px;
        border: none;
        background: transparent;
        transform: translateY(-43%);
      }
      button:focus {
        outline: none;
      }
      button i {
        font-size: 32px;
      }
      button i::before {
        -webkit-text-stroke: 1px #777;
        color: #fff;
      }
      textarea {
        width: 362px;
        max-width: 362px;
        padding: 8px;
        resize: none;
        margin: 6px 0px;
        font: menu !important;
      }
      textarea:focus {
        outline: none;
        border: 1px solid #666;
      }
      #close {
        width: 18px;
        height: 18px;
        position: absolute;
        right: 1px;
        top: 4px;
        color: #666;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="close">
      <i class="ion-close-round"></i>
    </div>
    <div id="top">
      <img src="../res/images/invis.png" id="notifimage"/>
      <div id="info">
        <h4 id="header">USER</h4>
        <p id="desc">MESSAGE</p>
      </div>
    </div>
    <div id="text_area">
      <textarea id="ta" resizable="false" placeholder="Ya wil be great! Jouinnin rite nao!"></textarea>
      <button onclick="sendReply()"><i class="ion-android-send"></i></button>
    </div>
    <script type="text/javascript">
      const { ipcRenderer, screen, remote } = require('electron');
      const rantscript = require('rantscript');

      const main = remote.require('./modules/notify.js');

      // This is lazy but it works ;)
      let currentReply = 0;
      let currentName = "";

      console.log(main)

      function sendReply() {
        let replyText = document.getElementById('ta').value;
        console.log(replyText)
        if(replyText.length > 0) {
          document.getElementById('ta').value = "";
          console.log('notif > send')
          main.ui().hide();
          main.send(currentReply, `@${currentName} ${replyText}`);
        }
      }

      function calcPos() {
        var np = screen.getDisplayNearestPoint(screen.getCursorScreenPoint());
        var ap = screen.getCursorScreenPoint();
        main.log(np)
        main.log(np.bounds.x + np.bounds.width - window.innerWidth - 12)
        if(ap.y > np.workArea.height / 2) {
          main.ui().setPosition(
            np.workArea.x + np.workArea.width - window.innerWidth - 12,
            np.workArea.y + np.workArea.height - window.innerHeight - 12
          )
        } else {
          main.ui().setPosition(
            np.workArea.x + np.workArea.width - window.innerWidth - 12,
            np.workArea.y + 12
          )
        }
      }

      calcPos()

      function sendNotif(n, i) {
        const myNotification = new Notification('devRantron', {
          body: n.body + ' Click here to reply.',
          icon: i,
        });

        myNotification.onclick = (e) => {
          calcPos();
          main.ui().show();
        };
      }

      document.getElementById('close').onclick = () => {
        main.ui().hide();
      }

      ipcRenderer.on('notifData', function (serder, n) {
        console.log(n)

        currentReply = n.id;

        rantscript
          .rant(n.id)
          .then((res)=>{
            console.log(res)
            for (comment of res.comments) {
              if(n.content.created_time  == comment.created_time) {
                document.getElementById('header').innerHTML = comment.user_username;
                currentName = comment.user_username;
                document.getElementById('desc').innerHTML = comment.body;
                if(comment.user_avatar.i != undefined) {
                  document.getElementById('notifimage').src = 'https://avatars.devrant.io/'+comment.user_avatar.i;
                } else {
                  document.getElementById('notifimage').src = '../res/images/invis.png';
                }
                document.getElementById('notifimage').style.background = '#'+comment.user_avatar.b;
                sendNotif(n, document.getElementById('notifimage').src);
                break;
              }
            }
          })
      });

    </script>
  </body>
</html>
